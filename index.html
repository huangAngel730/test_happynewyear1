<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#d93a28">
    <title>2026 丙午马年新春祝福</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // 自动注入 GitHub Pages 基础地址（由本地仓库检测填充）
        // 如果部署到了 GitHub Pages，这里会被替换为类似：
        // window.__SHARE_BASE__ = 'https://username.github.io/repo';
        window.__SHARE_BASE__ = 'https://huangAngel730.github.io/test_happynewyear1';
    </script>
    <!-- Google Fonts for diverse styles -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;700&family=ZCOOL+KuaiLe&family=Orbitron:wght@500&family=Press+Start+2P&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
</head>
<body class="style-china"> <!-- 默认国风 -->

    <!-- 氛围背景层：柔和光斑与网格 -->
    <div class="ambient">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="grid-overlay"></div>
    </div>

    <!-- 入口引导 -->
    <section class="entry-overlay" id="entryOverlay" aria-label="进入体验">
        <div class="entry-box">
            <p class="entry-kicker">2026 丙午马年 · 限定体验</p>
            <h1>灵马踏春 · 福满乾坤</h1>
            <p class="entry-note">这一场关于新春的奇遇，包含传统、科技与治愈。点击开始，开启您的专属祝福旅程。</p>
            <button id="entryStartBtn" class="entry-btn">开启旅程</button>
        </div>
    </section>

    <!-- 风格切换器 -->
    <nav class="theme-switcher">
        <button class="theme-btn" data-theme="style-china" onclick="switchTheme('style-china')">🏮 传统国风</button>
        <button class="theme-btn" data-theme="style-simple" onclick="switchTheme('style-simple')">🌿 简约清新</button>
        <button class="theme-btn" data-theme="style-cute" onclick="switchTheme('style-cute')">🦄 活泼卡通</button>
        <button class="theme-btn" data-theme="style-tech" onclick="switchTheme('style-tech')">🚀 科技未来</button>
        <button class="theme-btn" data-theme="style-warm" onclick="switchTheme('style-warm')">🧧 温馨治愈</button>
        <button class="theme-btn" data-theme="style-pixel" onclick="switchTheme('style-pixel')">🕹️ 像素复古</button>
        <button class="theme-btn" data-theme="style-noble" onclick="switchTheme('style-noble')">✨ 黑金贵雅</button>
    </nav>
    
    <!-- 祝福接力弹窗 -->
    <div id="relayModal" class="modal-overlay" aria-hidden="true" onclick="closeRelayModal(event)">
        <div class="modal-content relay-box">
            <div class="modal-header">
                <h2>🏃 新春祝福接力</h2>
                <button class="close-btn" onclick="closeRelayModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="relay-intro" id="relayIntro">
                    <p>发起或参与一场祝福接力，让福气传递下去！</p>
                    <button class="entry-btn small" onclick="startNewRelay()">发起新接力</button>
                </div>
                
                <div class="relay-chain-container" id="relayChainDisplay" style="display:none;">
                    <div class="chain-header">
                        当前接力第 <span id="relayCount">1</span> 棒
                    </div>
                    <div class="relay-timeline" id="relayTimeline">
                        <!-- JS 生成接力链 -->
                    </div>
                    
                    <div class="relay-action">
                        <textarea id="myRelayBlessing" placeholder="写下你的接力祝福..." maxlength="20"></textarea>
                        <button class="entry-btn" onclick="joinRelay()">加入接力 & 生成海报链接</button>
                    </div>
                    <button class="share-btn" onclick="shareRelayLink()">🔗 复制接力链接分享</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 截图分享卡片模态框 -->
    <div id="shareCardModal" class="modal-overlay" aria-hidden="true" onclick="closeShareCard()">
        <div class="modal-content share-card-box">
            <div class="share-card-container" id="shareCardNode">
                <div class="card-decoration top-left"></div>
                <div class="card-decoration top-right"></div>
                <div class="card-decoration bottom-left"></div>
                <div class="card-decoration bottom-right"></div>
                
                <div class="card-content">
                    <h3 class="card-year">2026 丙午马年</h3>
                    <div class="card-divider"></div>
                    <div class="card-wish" id="cardWishText">祝福语加载中...</div>
                    <div class="card-footer">
                        <div class="card-qr-box">
                            <div class="qr-placeholder">二维码</div>
                        </div>
                        <div class="card-sign">
                            <span>扫码接收祝福</span>
                            <small>Created with 2026 New Year Wish</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="share-tips">✨ 请直接截图分享图片 ✨</div>
            <button class="close-btn-round" onclick="closeShareCard()">关闭</button>
        </div>
    </div>

    <!-- 音乐控制悬浮球 -->
    <div class="music-controls hover-trigger">
        <div class="music-icon" id="musicToggle">🎵</div>
        <div class="control-panel">
            <button id="playPauseBtn">暂停</button>
            <button id="nextTrackBtn">切歌</button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
        </div>
    </div>
    
    <!-- 成就系统入口 -->
    <div class="achievement-entry" onclick="openAchievements()">
        🏆
        <div class="achievement-dot" id="achievementDot"></div>
    </div>

    <!-- 成就弹窗 -->
    <div id="achievementModal" class="modal-overlay" aria-hidden="true" onclick="closeAchievements(event)">
        <div class="modal-content achievement-box">
            <div class="modal-header">
                <h2>🏆 成就里程碑</h2>
                <button class="close-btn" onclick="closeAchievements()">×</button>
            </div>
            <div class="modal-body">
                <!-- 切换标签 -->
                <div class="ach-tabs" style="display:flex; gap:10px; margin-bottom:10px; justify-content:center;">
                    <button class="ach-tab active" onclick="switchAchTab('list')" style="padding:5px 15px; border:none; background:none; font-weight:bold; cursor:pointer; border-bottom:2px solid var(--primary-color);">成就列表</button>
                    <button class="ach-tab" onclick="switchAchTab('stats')" style="padding:5px 15px; border:none; background:none; opacity:0.6; cursor:pointer;">个人数据</button>
                </div>

                <div id="achTabList">
                    <div class="achievement-stats">
                        <div class="stat-item">
                            <span class="stat-val" id="achieveCount">0</span>
                            <span class="stat-label">已解锁</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-val" id="totalPoints">0</span>
                            <span class="stat-label">成就点</span>
                        </div>
                    </div>
                    <div class="achievement-list" id="achievementList">
                        <!-- JS 生成列表 -->
                    </div>
                </div>

                <div id="achTabStats" style="display:none; flex-direction:column; gap:15px; padding:10px;">
                    <div class="stat-card" style="background:rgba(0,0,0,0.03); padding:15px; border-radius:8px;">
                        <h4 style="margin:0 0 10px 0; border-bottom:1px solid #ddd; padding-bottom:5px;">📊 基础数据</h4>
                        <p>累计访问：<strong id="statVisitCount">0</strong> 次</p>
                        <p>连续签到：<strong id="statStreak">0</strong> 天</p>
                        <p>拥有积分：<strong id="statPoints">0</strong> 币</p>
                    </div>
                    <div class="stat-card" style="background:rgba(0,0,0,0.03); padding:15px; border-radius:8px;">
                        <h4 style="margin:0 0 10px 0; border-bottom:1px solid #ddd; padding-bottom:5px;">🎮 游戏记录</h4>
                        <p>最高得分：<strong id="statHighScore">0</strong></p>
                        <p>当前风格：<strong id="statTheme">-</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: 赛博求签弹窗 -->
    <div id="fortuneStickModal" class="modal-overlay" aria-hidden="true" onclick="closeFortuneStickModal(event)">
        <div class="modal-content fortune-box">
            <button class="close-btn" onclick="closeFortuneStickModal()">×</button>
            <div class="fortune-stage" id="fortuneStageStart">
                <h3>🧧 灵签问卜</h3>
                <p>心中默念愿望，诚心摇动签筒</p>
                <div class="divination-jar">
                    <div class="sticks-group">
                         <div class="stick s1"></div>
                         <div class="stick s2"></div>
                         <div class="stick s3"></div>
                         <div class="stick s4"></div>
                    </div>
                    <div class="jar-body">签</div>
                </div>
                <button class="action-btn main-btn" onclick="shakeFortuneStick()">👋 摇一摇 / 抽签</button>
            </div>
            
            <div class="fortune-stage" id="fortuneStageResult" style="display:none;">
                <div class="result-card">
                    <div class="result-header">
                        <span class="fortune-level" id="fortuneLevel">上上签</span>
                    </div>
                    <div class="result-poem">
                        <p class="poem-text" id="fortunePoem">风和日丽喜气盈</p>
                        <p class="poem-text" id="fortunePoem2">跃马扬鞭万里程</p>
                    </div>
                    <div class="result-interpret">
                        <h4>💡 赛博解签</h4>
                        <p id="fortuneModern">宜：提交代码不报错，买彩票必中，相亲成功率+50%</p>
                    </div>
                    <button class="action-btn" onclick="resetFortuneStick()">再求一签</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 成就解锁通知 Toast -->
    <div id="achievementToast" class="achievement-toast">
        <div class="toast-icon">🎉</div>
        <div class="toast-content">
            <div class="toast-title">成就解锁！</div>
            <div class="toast-desc" id="toastDesc">初次见面</div>
        </div>
    </div>

    <!-- 音乐提示（自动播放受阻时显示） -->
    <div id="musicPrompt" class="music-prompt" onclick="userEnableMusic()">🔊 点击播放音乐</div>
    
    <!-- 隐藏的音频元素 -->
    <audio id="bgm" loop preload="auto" autoplay playsinline>
        <!-- 默认源，JS会动态修改 -->
        <source src="https://music.163.com/song/media/outer/url?id=496527237.mp3" type="audio/mpeg">
    </audio>

    <!-- 主要内容区 -->
    <main class="container">
        
        <!-- 标题区域 -->
        <h1 class="main-title">
            <div class="year-glitch" data-text="2026">2026</div>
            <div class="china-title">
                <span class="char" style="--i:1">丙</span>
                <span class="char" style="--i:2">午</span>
                <span class="char" style="--i:3">马</span>
                <span class="char" style="--i:4">年</span>
            </div>
        </h1>
        <p class="tagline reveal">国风雅韵 · 科技赋能 · 沉浸式祈福</p>

        <!-- 1. 核心功能：选择场景并生成祝福 -->
        <section class="core-section reveal">
            <div class="scenario-switcher" aria-label="选择祝福场景">
                <button class="scenario-btn active" data-scenario="general" onclick="switchScenario('general')">通用</button>
                <button class="scenario-btn" data-scenario="career" onclick="switchScenario('career')">事业</button>
                <button class="scenario-btn" data-scenario="study" onclick="switchScenario('study')">学业</button>
                <button class="scenario-btn" data-scenario="health" onclick="switchScenario('health')">健康</button>
                <button class="scenario-btn" data-scenario="family" onclick="switchScenario('family')">家庭</button>
                <button class="scenario-btn" data-scenario="wealth" onclick="switchScenario('wealth')">财富</button>
                <button class="scenario-btn" data-scenario="travel" onclick="switchScenario('travel')">出行</button>
                <button class="scenario-btn" data-scenario="friends" onclick="switchScenario('friends')">友情</button>
            </div>

            <div class="wish-card" aria-live="polite">
                <p id="wishText" class="typing-effect">策马奔腾赴前程，春风得意马蹄疾！祝您2026年万事如意！</p>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="generateWish(true, true)">✨ 换一句祝福</button>
                    <button class="action-btn" onclick="toggleEdit()">✍ 自定义内容</button>
                </div>
                <div id="customWishArea" style="display:none; margin-top:15px;">
                    <input type="text" id="customInput" placeholder="输入您的专属祝福..." style="width:75%; padding:8px; border-radius:8px; border:1px solid var(--primary-color);">
                    <button class="action-btn small" onclick="confirmCustomBase()">确认</button>
                </div>
            </div>
        </section>

        <!-- 视觉装饰：马年视觉元素 -->
        <div class="visual-center reveal">
            <div class="horse-wrapper">
                <!-- 国风机甲马：融合传统剪纸与科技线路 -->
                <div class="mecha-horse-group china-horse">
                    <svg class="horse-svg" viewBox="0 0 100 100">
                        <defs>
                            <linearGradient id="mechaGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--primary-color);stop-opacity:1" />
                                <stop offset="100%" style="stop-color:var(--tech-accent);stop-opacity:1" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="1.5" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <!-- 马身主体 -->
                        <path d="M20,60 Q30,40 50,30 T80,40 L90,60 L80,80 L50,90 L20,80 Z" fill="url(#mechaGradient)" />
                        <!-- 科技线条纹路 -->
                        <path d="M30,50 L50,40 L70,50 M50,40 L50,80 M30,70 L50,80 L70,70" stroke="var(--tech-light)" stroke-width="1.5" fill="none" class="tech-lines" />
                        <!-- 关节光点 -->
                        <circle cx="30" cy="50" r="2" fill="#fff" class="tech-dot" />
                        <circle cx="70" cy="50" r="2" fill="#fff" class="tech-dot" />
                        <circle cx="50" cy="80" r="2" fill="#fff" class="tech-dot" />
                        
                        <text x="50" y="65" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="24" font-family="var(--font-family)" style="filter: url(#glow);">马</text>
                    </svg>
                    <!-- 全息光环 -->
                    <div class="holo-ring"></div>
                </div>

                <!-- 科技数字马 -->
                <div class="tech-horse-container">
                    <div class="tech-circle"></div>
                    <div class="tech-text">2026<br>HORSE</div>
                </div>

                <!-- 卡通小马 -->
                <div class="cute-horse-container">
                    <div class="cute-head">🐴</div>
                </div>

                <!-- 像素马 -->
                <div class="pixel-horse-container" aria-label="像素马">
                    <div class="pixel-art-horse"></div>
                </div>
            </div>
        </div>

        <div class="fu-badge" id="fuBadge" aria-label="点福得祝福">福</div>

        <!-- NEW: 赛博求签入口 -->
        <div class="fortune-stick-entry" onclick="openFortuneStickModal()">
            <div class="stick-jar-icon">🥡</div>
            <span>赛博求签</span>
        </div>

        <!-- 2. 祝福分享与社交接力 -->
        <section class="social-section reveal">
            <h3 class="section-title">传播福气</h3>
            <div class="action-buttons">
                <button class="action-btn social-btn share-card-trigger" onclick="openShareCard()">📸 生成精美卡片</button>
                <button class="action-btn social-btn relay-btn-trigger" onclick="openRelayModal()">🏃 参与祝福接力</button>
                <button class="action-btn social-btn" onclick="copyWish()">📋 复制祝福文案</button>
                <button class="action-btn social-btn" onclick="copyPageLink()">🔗 分享活动链接</button>
            </div>
        </section>

        <!-- 3. 成就里程碑与数据 -->
        <section class="milestone-section reveal">
            <h3 class="section-title">我的马年足迹</h3>
            <div class="info-grid">
                <article class="info-card">
                    <div class="card-top">福气指数</div>
                    <div class="card-body">
                        <div class="counter" id="fortuneCounter" aria-live="polite">0%</div>
                        <p>击败 <span id="beatPercent">0</span>% 网友</p>
                    </div>
                </article>
                <article class="info-card">
                    <div class="card-top">成就探索</div>
                    <div class="card-body">
                        <div class="achievement-brief" onclick="openAchievements()">
                            <span id="achieveCount">0</span> 项成就已达成
                        </div>
                        <button class="action-btn ghost small" onclick="openAchievements()" style="margin-top:10px;">查看里程碑</button>
                    </div>
                </article>
                <article class="info-card mission-card">
                    <div class="card-top">福气任务</div>
                    <div class="card-body">
                        <div class="mission-header">
                            <span id="missionProgressText">0/5</span>
                        </div>
                        <div class="mission-list" id="missionList"></div>
                    </div>
                </article>
            </div>

            <!-- 祝福能量进度 -->
            <div class="highlight-meta">
                <div class="progress-track">
                    <div class="progress-label-row">
                        <div class="progress-label">福气能量收集</div>
                        <div class="progress-value" id="energyNumber">0%</div>
                    </div>
                    <div class="progress-bar">
                        <span class="progress-fill" id="energyFill"></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 风格与玩法入口 -->
        <section class="other-section reveal">
            <h3 class="section-title">更多体验</h3>
            <div class="info-grid">
                <article class="info-card">
                    <div class="card-top">活力时刻</div>
                    <div class="card-body">
                        <button class="menu-btn" onclick="openMenuModal()">🍽️ 年夜饭推荐</button>
                        <button class="menu-btn" onclick="openTriviaModal()">🐴 马年冷知识</button>
                    </div>
                </article>
                <article class="info-card">
                    <div class="card-top">休闲娱乐</div>
                    <div class="card-body">
                        <button class="action-btn ghost" onclick="openGameOverlay()">🎮 跨年小游戏</button>
                        <button class="action-btn ghost" onclick="openGuide()">❔ 使用指南</button>
                    </div>
                </article>
            </div>
        </section>

        <!-- 分场景列表区 -->
        <section class="deep-wishes reveal" aria-label="分场景祝福">
            <div class="section-head">
                <h2>全场景祝愿</h2>
                <p>为您精选不同生活场景的诚挚话语</p>
            </div>
            <div class="deep-grid">
                <article class="deep-card" data-deep-key="general">
                    <div class="deep-title">通用祝愿 <button class="deep-next" data-deep-key="general">换一条</button></div>
                    <ul class="deep-list"></ul>
                </article>
                <article class="deep-card" data-deep-key="career">
                    <div class="deep-title">事业腾飞 <button class="deep-next" data-deep-key="career">换一条</button></div>
                    <ul class="deep-list"></ul>
                </article>
                <article class="deep-card" data-deep-key="health">
                    <div class="deep-title">健康平安 <button class="deep-next" data-deep-key="health">换一条</button></div>
                    <ul class="deep-list"></ul>
                </article>
                <article class="deep-card" data-deep-key="family">
                    <div class="deep-title">家庭团圆 <button class="deep-next" data-deep-key="family">换一条</button></div>
                    <ul class="deep-list"></ul>
                </article>
                <article class="deep-card" data-deep-key="fortune">
                    <div class="deep-title">财富顺遂 <button class="deep-next" data-deep-key="fortune">换一条</button></div>
                    <ul class="deep-list"></ul>
                </article>
            </div>
        </section>
    </main>

    <!-- 飘落物容器 -->
    <div id="falling-container"></div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- 使用指南模态框 -->
    <div id="guideModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeGuide()">×</span>
            <h2>🧧 使用指南</h2>
            <ul>
                <li><strong>切换风格</strong>：点击顶部按钮切换 国风/科技/卡通 风格。</li>
                <li><strong>背景音乐</strong>：左下角悬浮球控制音乐播放/暂停及音量。</li>
                <li><strong>互动特效</strong>：点击页面任意空白处触发特效（红包/光效/糖果）。</li>
                <li><strong>自定义</strong>：修改HTML内的JS配置区即可替换祝福语。</li>
            </ul>
        </div>
        <div class="modal-footer">
            <button onclick="closeGuide()">我知道了</button>
        </div>
    </div>

    <!-- 跨年小游戏全屏弹层 -->
    <div id="gameOverlay" class="game-overlay" aria-modal="true" role="dialog" aria-label="跨年小游戏">
        <div class="game-panel">
            <div class="game-header">
                <h2>🎮 跨年小游戏</h2>
                <span class="close-btn" onclick="closeGameOverlay()">×</span>
            </div>
            <p id="gameDescription" class="game-desc">根据当前风格选择或随机体验该风格的小游戏，支持更多主题专属玩法。</p>
            <div class="game-info">
                <span class="game-badge">模式：<strong id="gameMode">待选择</strong></span>
                <span class="game-badge">得分：<strong id="gameScore">0</strong></span>
                <span class="game-badge">时间：<strong id="gameTimer">--</strong>s</span>
                <span class="game-badge">生命：<strong id="gameLives">3</strong></span>
                <span class="game-badge">连击：<strong id="gameCombo">0</strong>x</span>
            </div>
            <div id="gameArea" class="game-area" tabindex="0"></div>
            <div id="gamePicker" class="game-picker"></div>
            <div class="game-actions">
                <button class="action-btn" onclick="startGameButton()">▶ 开始</button>
                <button class="action-btn ghost" onclick="closeGameOverlay()">退出</button>
            </div>
            <p class="game-hint">提示：竖屏体验最佳，移动端用左右滑动/轻点，桌面可用左右键。</p>
        </div>
    </div>

    <footer style="text-align: center; padding: 20px; color: var(--text-color); opacity: 0.8; font-size: 0.9rem; margin-top: 30px;">
        本祝福网站由huangshiqi制作，如有模仿请注明出处
    </footer>

    <!-- 回到顶部 -->
    <button id="scrollTopBtn" class="scroll-top-btn" onclick="window.scrollTo({top:0, behavior:'smooth'})" aria-label="回到顶部">
        ↑
    </button>

    <!-- 脚本引用 -->
    <script src="script.js"></script>
</body>
</html>